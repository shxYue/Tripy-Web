<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  <title>冲浪小游戏（合并版）</title>
  <link rel="stylesheet" href="common.css">
  <style>
    /* 保留或调整页面独有样式 */
    /* body 样式已在 common.css 中统一定义，无需重复声明 */
  </style>
</head>
<body>
  <div id="headerContainer"></div>
  <div class="main-content">
    <h1>冲浪小游戏</h1>
    <div>
      <label>玩家名称:
        <input type="text" id="playerName" placeholder="输入玩家名称">
      </label>
    </div>
    <div>
      <button onclick="startGame()">开始游戏</button>
      <button onclick="moveForward()">前进一步</button>
      <button onclick="checkStatus()">查看状态</button>
      <button onclick="resetGame()">重置游戏</button>
    </div>
    <div id="output"></div>
    <canvas id="gameCanvas" width="400" height="600"></canvas>
  </div>
  
  <script>
    // 加载公共顶栏
    fetch('header.html')
      .then(response => response.text())
      .then(html => {
         document.getElementById('headerContainer').innerHTML = html;
         checkAuth && checkAuth();
      })
      .catch(err => console.error('加载 header 失败：', err));
  </script>
  
  <!-- 保留原有的冲浪小游戏JS逻辑 -->
  <script>
    // 后端 API 基础地址
    const baseUrl = "http://127.0.0.1:8000/surf";
    // 用于显示接口返回信息
    function showOutput(msg) {
      document.getElementById("output").innerText = msg;
    }
    // 获取玩家名称（若为空则抛错）
    function getPlayer() {
      const player = document.getElementById("playerName").value.trim();
      if (!player) {
        alert("请先输入玩家名称");
        throw new Error("玩家名称为空");
      }
      return player;
    }
    
    // 全局游戏状态（来自后端接口）
    let gameState = {
      player: "",
      position: 0,
      score: 0,
      is_active: false
    };
    
    // API 调用并更新全局状态
    async function startGame() {
      const player = getPlayer();
      try {
        const response = await fetch(`${baseUrl}/start?player=${encodeURIComponent(player)}`, { method: "POST" });
        const data = await response.json();
        gameState = data.state;
        showOutput(JSON.stringify(data, null, 2));
      } catch (error) {
        showOutput("错误: " + error);
      }
    }
    
    async function moveForward() {
      const player = getPlayer();
      try {
        const response = await fetch(`${baseUrl}/forward?player=${encodeURIComponent(player)}`, { method: "POST" });
        const data = await response.json();
        gameState = data.state;
        showOutput(JSON.stringify(data, null, 2));
      } catch (error) {
        showOutput("错误: " + error);
      }
    }
    
    async function checkStatus() {
      const player = getPlayer();
      try {
        const response = await fetch(`${baseUrl}/status?player=${encodeURIComponent(player)}`);
        const data = await response.json();
        gameState = data;
        showOutput(JSON.stringify(data, null, 2));
      } catch (error) {
        showOutput("错误: " + error);
      }
    }
    
    async function resetGame() {
      const player = getPlayer();
      try {
        const response = await fetch(`${baseUrl}/reset?player=${encodeURIComponent(player)}`, { method: "POST" });
        const data = await response.json();
        gameState = data.state;
        showOutput(JSON.stringify(data, null, 2));
      } catch (error) {
        showOutput("错误: " + error);
      }
    }
    
    // Canvas 动画部分
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // 绘制冲浪者，位置根据 gameState.position 控制（比如向上移动）
    function drawSurfer() {
      // 用一个简单的矩形表示冲浪者
      ctx.fillStyle = "#ff6600";
      // 基于游戏状态中 position 改变 y 坐标；position 越大，冲浪者越高
      const baseY = 550; // 初始底部位置
      const y = baseY - gameState.position; 
      ctx.fillRect(180, y, 40, 20);
    }
    
    // 绘制简单的背景和显示分数
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // 背景（可添加其他图案）
      ctx.fillStyle = "#b3e0ff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      drawSurfer();
      // 绘制分数显示在画布上
      ctx.font = "20px Arial";
      ctx.fillStyle = "#333";
      ctx.fillText("得分: " + gameState.score, 10, 30);
    }
    
    // 动画循环；每次刷新时绘制当前状态
    function gameLoop() {
      draw();
      requestAnimationFrame(gameLoop);
    }
    
    // 启动动画循环
    gameLoop();
  </script>
</body>
</html>